<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Geomancy / åœ°å é›™ç›¤ç³»çµ±</title>

  <meta property="og:title" content="Geomancy / åœ°å é›™ç›¤ç³»çµ±" />
  <meta property="og:description" content="å•Ÿå‹•èµ·å¦å„€å¼ / Start the ritual" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://jean755899.github.io/geomancy_-ShieldChart/" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Geomancy / åœ°å é›™ç›¤ç³»çµ±" />
  <meta name="twitter:description" content="å•Ÿå‹•èµ·å¦å„€å¼ / Start the ritual" />

  <style>
    :root { --gold: #d4af37; --bg: #1a1a1a; --card: #262626; --text: #eee; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--gold); font-family: "Times New Roman", serif; margin: 0; padding: 10px; text-align: center; }

    .topbar{
      max-width: 520px;
      margin: 0 auto 10px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .lang{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(212,175,55,0.35);
      background: rgba(212,175,55,0.06);
      color: #dcdcdc;
      font-size: 12px;
    }
    .lang select{
      background: #333; color: var(--gold);
      border: 1px solid rgba(212,175,55,0.65);
      border-radius: 8px;
      height: 30px;
      font-size: 12px;
      padding: 0 8px;
      min-width: 120px;
    }

    .controls { background: var(--card); border: 1px solid #444; padding: 12px; border-radius: 8px; margin-bottom: 14px; max-width: 520px; margin: 0 auto; }
    .select-row { display: flex; justify-content: space-between; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
    select { background: #333; color: var(--gold); border: 1px solid var(--gold); border-radius: 4px; font-size: 11px; flex: 1 1 calc(25% - 6px); height: 32px; text-align: center; min-width: 120px; }

    .btn-row { display: flex; gap: 8px; justify-content: space-between; flex-wrap: wrap; }
    button { background: var(--gold); color: #000; border: none; padding: 10px 12px; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer; flex: 1 1 160px; }
    button.alt { background:#444; color:#fff; }
    button.soft { background: rgba(212,175,55,0.18); color: var(--gold); border: 1px solid rgba(212,175,55,0.45); }
    button.danger { background: rgba(255,80,80,0.18); color: #ffd1d1; border: 1px solid rgba(255,80,80,0.45); }

    .mode-box {
      max-width: 520px;
      margin: 0 auto 14px;
      border: 1px solid rgba(212,175,55,0.45);
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
      padding: 12px;
      text-align: left;
    }
    .mode-title { color: var(--gold); font-weight: bold; font-size: 13px; margin-bottom: 6px; }
    .mode-sub { color: #bdbdbd; font-size: 12px; line-height: 1.45; margin-bottom: 10px; }

    .pad {
      height: 110px;
      border-radius: 10px;
      border: 1px solid rgba(212,175,55,0.35);
      background: linear-gradient(180deg, rgba(212,175,55,0.06), rgba(0,0,0,0.0));
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.75);
      font-size: 12px;
      user-select: none;
      -webkit-user-select: none;
    }
    .pad.slide { touch-action: none; }
    .pad.disabled { opacity: 0.55; filter: grayscale(0.2); border-style: dashed; }

    .status-row { margin-top: 10px; color:#bdbdbd; font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .status-row b { color: var(--gold); }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,0.35);
      background: rgba(212,175,55,0.06);
      color: #cfcfcf;
      font-size: 12px;
    }
    .pill b{ color: var(--gold); }

    .qbox{
      max-width: 520px;
      margin: 0 auto 14px;
      border: 1px solid rgba(212,175,55,0.45);
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
      padding: 12px;
      text-align: left;
    }
    .qbox label{
      display:block;
      font-weight: bold;
      color: var(--gold);
      font-size: 13px;
      margin-bottom: 8px;
    }
    .qbox textarea{
      width: 100%;
      min-height: 80px;
      resize: vertical;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(212,175,55,0.35);
      background: rgba(0,0,0,0.35);
      color: #eaeaea;
      font-size: 13px;
      line-height: 1.5;
      outline: none;
    }
    .qbox textarea:focus{
      border-color: rgba(212,175,55,0.7);
      box-shadow: 0 0 0 2px rgba(212,175,55,0.15);
    }
    .qmeta{
      margin-top: 8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content: space-between;
      color:#bdbdbd;
      font-size: 12px;
    }
    .qmeta b{ color: var(--gold); }
    .qpreview{
      max-width: 520px;
      margin: 0 auto 10px;
      padding: 10px 12px;
      border-left: 3px solid rgba(212,175,55,0.75);
      background: rgba(212,175,55,0.05);
      color:#dcdcdc;
      text-align:left;
      border-radius: 10px;
      display:none;
    }
    .qpreview .t{ color: var(--gold); font-weight: bold; margin-bottom: 6px; font-size: 12px; }
    .qpreview .c{ white-space: pre-wrap; font-size: 13px; line-height: 1.45; }

    .coin-wrap{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .coin{
      width:76px; height:76px; border-radius:50%;
      border: 2px solid rgba(212,175,55,0.75);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.28), rgba(212,175,55,0.16), rgba(0,0,0,0.06));
      position: relative;
      display:flex; align-items:center; justify-content:center;
      transform-style: preserve-3d;
      perspective: 800px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      user-select:none; -webkit-user-select:none;
    }
    .coin::before, .coin::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:50%;
      border: 1px dashed rgba(212,175,55,0.45);
    }
    .coin-face{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      color: var(--gold);
      backface-visibility: hidden;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    .coin-front{ transform: rotateY(0deg); }
    .coin-back{ transform: rotateY(180deg); color: rgba(255,255,255,0.85); }
    .coin.flip-heads{ animation: coinFlipHeads 520ms ease-out; }
    .coin.flip-tails{ animation: coinFlipTails 520ms ease-out; }
    @keyframes coinFlipHeads{
      0%{ transform: rotateY(0) rotateZ(0) scale(1); }
      35%{ transform: rotateY(270deg) rotateZ(8deg) scale(1.05); }
      100%{ transform: rotateY(360deg) rotateZ(0) scale(1); }
    }
    @keyframes coinFlipTails{
      0%{ transform: rotateY(0) rotateZ(0) scale(1); }
      35%{ transform: rotateY(450deg) rotateZ(-8deg) scale(1.05); }
      100%{ transform: rotateY(540deg) rotateZ(0) scale(1); }
    }

    .shield-box { border: 2px solid var(--gold); background: var(--card); padding: 5px; max-width: 500px; margin: 0 auto; }
    .row-8 { display: flex; width: 100%; border-bottom: 1px solid #444; }
    .row-4 { display: flex; width: 100%; justify-content: space-around; padding-top: 10px; }
    .row-2 { display: flex; width: 100%; justify-content: space-around; padding-top: 15px; }
    .row-1 { display: flex; width: 100%; justify-content: center; padding-top: 15px; }

    .cell { flex: 1 1 0; min-width: 0; border: 0.5px solid #333; padding: 4px 0; display: flex; flex-direction: column; align-items: center; background: #1f1f1f; }
    .idx { font-size: 9px; color: #888; font-weight: bold; }
    .dots { font-size: 10px; line-height: 1.1; color: #f9d342; font-family: monospace; padding: 3px 0; }

    .f15 { width: 85px; background: #333; clip-path: polygon(0 0, 100% 0, 50% 100%); padding-bottom: 18px; border: 1px solid var(--gold); }
    .reconciler-wrap { display: flex; justify-content: center; margin-top: 10px; padding-bottom: 5px; }
    .f16 { width: 90px; border: 1px dashed var(--gold); background: rgba(212, 175, 55, 0.05); border-radius: 10px; padding: 5px 0; position: relative; }
    .f16::before { content: "RECONCILER"; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 0 5px; font-size: 8px; color: var(--gold); opacity: 0.7; }

    .house-svg-container { width: 340px; height: 340px; margin: 20px auto; position: relative; }
    svg { width: 100%; height: 100%; }
    .line { stroke: var(--gold); stroke-width: 1.5; fill: none; }
    .h-dots { fill: #f9d342; font-size: 10.5px; font-family: monospace; text-anchor: middle; }
    .h-meta { fill: var(--gold); font-size: 9px; font-weight: bold; }

    .footer { margin-top: 30px; padding: 20px 10px; border-top: 1px solid #333; font-size: 12px; color: #888; }
    .footer b { color: var(--gold); }

    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.92);
      display: none;
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .overlay-card {
      width: min(520px, 94vw);
      border: 1px solid rgba(212,175,55,0.45);
      border-radius: 14px;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      text-align: left;
    }
    .overlay-title { color: var(--gold); font-weight: bold; font-size: 14px; margin-bottom: 8px; }
    .overlay-sub { color:#cfcfcf; font-size: 12px; line-height: 1.5; margin-bottom: 12px; }
    .overlay-pad {
      height: 220px;
      border-radius: 12px;
      border: 1px solid rgba(212,175,55,0.35);
      background: radial-gradient(circle at 50% 40%, rgba(212,175,55,0.12), rgba(0,0,0,0.0));
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,0.75);
      font-size: 12px;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    .overlay-row { margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap; }
    .overlay-row button { flex: 1 1 160px; }

    @media (max-width: 420px) {
      .controls { padding: 10px; }
      select { flex: 1 1 calc(50% - 6px); min-width: 0; font-size: 12px; height: 34px; }
      button { font-size: 14px; }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <h2 id="ui_title" style="margin:6px 0;">ğŸ“œ Geomancy Ritual</h2>
    <div class="lang">
      <span id="ui_langLabel">èªè¨€</span>
      <select id="langSelect">
        <option value="zh-Hant">ç¹é«”ä¸­æ–‡</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>

  <div class="controls">
    <div class="select-row">
      <select id="m1_s"></select>
      <select id="m2_s"></select>
      <select id="m3_s"></select>
      <select id="m4_s"></select>
    </div>
    <div class="btn-row">
      <button id="ui_btnManual" onclick="manualCast()">æŒ‡å®šå¦è±¡è¨ˆç®—</button>
      <button id="ui_btnRandom" class="alt" onclick="randomCast()">ç´”éš¨æ©Ÿï¼ˆMath.randomï¼‰</button>
    </div>
  </div>

  <div class="mode-box">
    <div id="ui_tapTitle" class="mode-title">é–‰çœ¼é»æ“Šèµ·å¦ï¼ˆ16 æ¬¡ï¼šç«â†’é¢¨â†’æ°´â†’åœŸï¼Œå››æ¯å¦ä¾åºï¼‰</div>
    <div id="ui_tapDesc" class="mode-sub">
      é»æ“Šé †åºå›ºå®šç‚ºï¼šç¬¬ 1 æ¯å¦ ç«/é¢¨/æ°´/åœŸ â†’ ç¬¬ 2 â†’ ç¬¬ 3 â†’ ç¬¬ 4ã€‚å…± 16 æ¬¡ã€‚<br>
      æ¯æ¬¡é»æ“Šä»¥ã€Œæ™‚é–“å·® + é»æ“Šåº§æ¨™ã€å–å¥‡å¶ï¼Œæ±ºå®šå–®é»(1)/é›™é»(2)ã€‚
    </div>
    <div class="btn-row">
      <button id="ui_btnTapStart" class="soft" onclick="startTapCast()">é–‹å§‹é–‰çœ¼é»æ“Š</button>
      <button id="ui_btnTapCancel" class="alt" onclick="cancelTapCast()">å–æ¶ˆ/é—œé–‰</button>
    </div>
  </div>

  <div class="mode-box">
    <div id="ui_shakeTitle" class="mode-title">æ–æ™ƒæŠ•å¹£èµ·å¦ï¼ˆ16 æ¬¡ï¼šç«â†’é¢¨â†’æ°´â†’åœŸ Ã—4ï¼‰</div>
    <div id="ui_shakeDesc" class="mode-sub">
      é»æ“Šã€Œå•Ÿç”¨æ–æ™ƒã€å¾Œï¼Œæ–æ™ƒæ‰‹æ©Ÿä¸€æ¬¡è¨˜ 1 æ¬¡æŠ•å¹£ï¼Œç›´åˆ° 16 æ¬¡è‡ªå‹•å®šå¦ã€‚iOS å¯èƒ½æœƒè·³å‡ºæ¬Šé™è¦–çª—ï¼Œè«‹å…è¨±ã€‚<br>
      è¦å‰‡ï¼šHEADS â†’ 1ï¼ˆå–®ï¼‰ã€TAILS â†’ 2ï¼ˆé›™ï¼‰
    </div>

    <div class="coin-wrap">
      <div class="coin" id="coin">
        <div class="coin-face coin-front">HEADS</div>
        <div class="coin-face coin-back">TAILS</div>
      </div>

      <div style="flex:1 1 220px; min-width: 220px;">
        <div class="status-row" style="margin-top:0;">
          <span class="pill"><span id="ui_shakeStatusLabel">ç‹€æ…‹</span>ï¼š<b id="shakeStatus">æœªå•Ÿç”¨</b></span>
          <span class="pill"><span id="ui_shakeProgLabel">é€²åº¦</span>ï¼š<b id="shakeProg">0</b>/16</span>
          <span class="pill"><span id="ui_shakeLastLabel">ä¸Šæ¬¡</span>ï¼š<b id="shakeLast">â€”</b></span>
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <button id="ui_btnShakeEnable" class="soft" onclick="enableShakeCoin()">å•Ÿç”¨æ–æ™ƒ</button>
          <button id="ui_btnShakeStop" class="alt" onclick="disableShakeCoin()">åœæ­¢</button>
        </div>
      </div>
    </div>
  </div>

  <div class="mode-box">
    <div id="ui_slideTitle" class="mode-title">æŒ‰ä½æ»‘å‹•èµ·å¦ï¼ˆéœ€å…ˆå•Ÿå‹•ï¼‰</div>
    <div id="ui_slideDesc" class="mode-sub">
      å…ˆæŒ‰ã€Œå•Ÿå‹•æ»‘å‹•èµ·å¦ã€ï¼Œå†åœ¨ä¸‹æ–¹å€å¡ŠæŒ‰ä½æ»‘å‹•ï¼›æ”¾é–‹å¾Œå°‡è·¯å¾‘åˆ‡æˆ 16 æ®µï¼Œå„æ®µè·é›¢å¥‡å¶æ±ºå®šå–®/é›™ã€‚
    </div>

    <div class="btn-row">
      <button id="ui_btnSlideEnable" class="soft" onclick="enableSlideCast()">å•Ÿå‹•æ»‘å‹•èµ·å¦</button>
      <button id="ui_btnSlideDisable" class="danger" onclick="disableSlideCast()">åœæ­¢/é–å®šæ»‘å‹•</button>
    </div>

    <div id="gesturePad" class="pad slide disabled">ï¼ˆæœªå•Ÿå‹•ï¼‰è«‹å…ˆæŒ‰ã€Œå•Ÿå‹•æ»‘å‹•èµ·å¦ã€</div>
    <div class="status-row">
      <span id="ui_gStatusLabel">ç‹€æ…‹ï¼š<b id="gStatus">é–å®š</b></span>
      <span id="ui_gDistLabel">è·é›¢ï¼š<b id="gDist">0</b></span>
      <span id="ui_gSegLabel">æ®µæ•¸ï¼š<b id="gSeg">0</b>/16</span>
    </div>
  </div>

  <div class="qbox">
    <label id="ui_qLabel" for="questionInput">å•é¡Œï¼ˆå¯é¸å¡«ï¼‰</label>
    <textarea id="questionInput" maxlength="300" placeholder="ä¾‹å¦‚ï¼šé€™æ®µé—œä¿‚æ¥ä¸‹ä¾†ä¸‰å€‹æœˆçš„èµ°å‘ï¼Ÿ / é€™å€‹åˆä½œæ¡ˆæ˜¯å¦å€¼å¾—æŠ•å…¥ï¼Ÿ"></textarea>
    <div class="qmeta">
      <span><span id="ui_qCountLabel">å­—æ•¸</span>ï¼š<b id="qCount">0</b>/300</span>
      <span id="ui_qHint">æç¤ºï¼šèµ·å¦å¾Œæœƒé¡¯ç¤ºåœ¨çµæœä¸Šæ–¹</span>
    </div>
  </div>

  <div id="questionPreview" class="qpreview">
    <div id="ui_qPreviewTitle" class="t">æœ¬æ¬¡å•é¡Œ</div>
    <div id="questionPreviewText" class="c"></div>
  </div>

  <div class="shield-box">
    <div id="s_row1" class="row-8"></div>
    <div id="s_row2" class="row-4"></div>
    <div id="s_row3" class="row-2"></div>
    <div id="s_row4" class="row-1"></div>
    <div id="s_row5" class="reconciler-wrap"></div>
  </div>

  <h3 id="ui_houseTitle">ğŸ›ï¸ House Chart</h3>
  <div id="h_container" class="house-svg-container"></div>

  <div id="ui_footer" class="footer">
  å¦‚æœ‰ä»»ä½•å•é¡Œèˆ‡æ„è¦‹å›é¥‹ï¼Œè«‹èˆ‡æˆ‘è¯ç¹«<br><br>

  <b>Instagramï¼š</b><br>
  <a href="https://www.instagram.com/grove_hellenism?igsh=dnNyOTdsYm03eGly&utm_source=qr"
     target="_blank" rel="noopener noreferrer">
    https://www.instagram.com/grove_hellenism
  </a><br>
  <a href="https://www.instagram.com/grove_and_roots?igsh=MTgzaDhzcW82d2Q1Mw=="
     target="_blank" rel="noopener noreferrer">
    https://www.instagram.com/grove_and_roots
  </a><br><br>

  å¦‚æœä½ éœ€è¦å°ˆæ¥­ã€è©³ç›¡çš„è§£è®€ï¼Œä¹Ÿå¯ä»¥å°‡çµæœæˆªåœ–å¾Œç§è¨Šæˆ‘ã€‚
</div>

  <div id="tapOverlay" class="overlay">
    <div class="overlay-card">
      <div id="ui_overlayTitle" class="overlay-title">é–‰çœ¼é»æ“Šèµ·å¦</div>
      <div id="ui_overlaySub" class="overlay-sub">
        è«‹é–‰çœ¼ï¼Œéš¨æ„é»æ“Šä¸‹æ–¹å€å¡Š 16 æ¬¡ã€‚<br>
        é€²åº¦ï¼š<b id="tapProg">0</b>/16ã€€ç›®å‰ï¼š<b id="tapStage">ç¬¬ 1 æ¯å¦ï¼ç«</b>
      </div>
      <div id="tapPad" class="overlay-pad">é»æˆ‘ï¼ˆé–‰çœ¼ï¼‰</div>
      <div class="overlay-row">
        <button id="ui_overlayCancel" class="alt" onclick="cancelTapCast()">å–æ¶ˆ</button>
        <button id="ui_overlayReset" class="soft" onclick="resetTapCast()">é‡ç½®é€²åº¦</button>
      </div>
    </div>
  </div>

  <script>
    const I18N = {
      "zh-Hant": {
        langLabel: "èªè¨€",
        title: "ğŸ“œ Geomancy Ritual",
        btnManual: "æŒ‡å®šå¦è±¡è¨ˆç®—",
        btnRandom: "ç´”éš¨æ©Ÿï¼ˆMath.randomï¼‰",
        tapTitle: "é–‰çœ¼é»æ“Šèµ·å¦ï¼ˆ16 æ¬¡ï¼šç«â†’é¢¨â†’æ°´â†’åœŸï¼Œå››æ¯å¦ä¾åºï¼‰",
        tapDesc: "é»æ“Šé †åºå›ºå®šç‚ºï¼šç¬¬ 1 æ¯å¦ ç«/é¢¨/æ°´/åœŸ â†’ ç¬¬ 2 â†’ ç¬¬ 3 â†’ ç¬¬ 4ã€‚å…± 16 æ¬¡ã€‚<br>æ¯æ¬¡é»æ“Šä»¥ã€Œæ™‚é–“å·® + é»æ“Šåº§æ¨™ã€å–å¥‡å¶ï¼Œæ±ºå®šå–®é»(1)/é›™é»(2)ã€‚",
        btnTapStart: "é–‹å§‹é–‰çœ¼é»æ“Š",
        btnTapCancel: "å–æ¶ˆ/é—œé–‰",
        shakeTitle: "æ–æ™ƒæŠ•å¹£èµ·å¦ï¼ˆ16 æ¬¡ï¼šç«â†’é¢¨â†’æ°´â†’åœŸ Ã—4ï¼‰",
        shakeDesc: "é»æ“Šã€Œå•Ÿç”¨æ–æ™ƒã€å¾Œï¼Œæ–æ™ƒæ‰‹æ©Ÿä¸€æ¬¡è¨˜ 1 æ¬¡æŠ•å¹£ï¼Œç›´åˆ° 16 æ¬¡è‡ªå‹•å®šå¦ã€‚iOS å¯èƒ½æœƒè·³å‡ºæ¬Šé™è¦–çª—ï¼Œè«‹å…è¨±ã€‚<br>è¦å‰‡ï¼šHEADS â†’ 1ï¼ˆå–®ï¼‰ã€TAILS â†’ 2ï¼ˆé›™ï¼‰",
        shakeStatusLabel: "ç‹€æ…‹",
        shakeProgLabel: "é€²åº¦",
        shakeLastLabel: "ä¸Šæ¬¡",
        btnShakeEnable: "å•Ÿç”¨æ–æ™ƒ",
        btnShakeStop: "åœæ­¢",
        slideTitle: "æŒ‰ä½æ»‘å‹•èµ·å¦ï¼ˆéœ€å…ˆå•Ÿå‹•ï¼‰",
        slideDesc: "å…ˆæŒ‰ã€Œå•Ÿå‹•æ»‘å‹•èµ·å¦ã€ï¼Œå†åœ¨ä¸‹æ–¹å€å¡ŠæŒ‰ä½æ»‘å‹•ï¼›æ”¾é–‹å¾Œå°‡è·¯å¾‘åˆ‡æˆ 16 æ®µï¼Œå„æ®µè·é›¢å¥‡å¶æ±ºå®šå–®/é›™ã€‚",
        btnSlideEnable: "å•Ÿå‹•æ»‘å‹•èµ·å¦",
        btnSlideDisable: "åœæ­¢/é–å®šæ»‘å‹•",
        slidePadLocked: "ï¼ˆæœªå•Ÿå‹•ï¼‰è«‹å…ˆæŒ‰ã€Œå•Ÿå‹•æ»‘å‹•èµ·å¦ã€",
        slidePadEnabled: "ï¼ˆå·²å•Ÿå‹•ï¼‰æŒ‰ä½æ­¤è™•ä¸¦æ»‘å‹• â†’ æ”¾é–‹å³å®šå¦",
        gStatus: "ç‹€æ…‹ï¼š",
        gDist: "è·é›¢ï¼š",
        gSeg: "æ®µæ•¸ï¼š",
        qLabel: "å•é¡Œï¼ˆå¯é¸å¡«ï¼‰",
        qPlaceholder: "ä¾‹å¦‚ï¼šé€™æ®µé—œä¿‚æ¥ä¸‹ä¾†ä¸‰å€‹æœˆçš„èµ°å‘ï¼Ÿ / é€™å€‹åˆä½œæ¡ˆæ˜¯å¦å€¼å¾—æŠ•å…¥ï¼Ÿ",
        qCountLabel: "å­—æ•¸",
        qHint: "æç¤ºï¼šèµ·å¦å¾Œæœƒé¡¯ç¤ºåœ¨çµæœä¸Šæ–¹",
        qPreviewTitle: "æœ¬æ¬¡å•é¡Œ",
        houseTitle: "ğŸ›ï¸ House Chart",
        footer: 'å¦‚æœ‰ä»»ä½•å•é¡Œèˆ‡æ„è¦‹å›é¥‹ï¼Œè«‹èˆ‡æˆ‘è¯ç¹«<br><b>instagram: grove_and_roots</b>',
        overlayTitle: "é–‰çœ¼é»æ“Šèµ·å¦",
        overlayCancel: "å–æ¶ˆ",
        overlayReset: "é‡ç½®é€²åº¦",
        overlayPad: "é»æˆ‘ï¼ˆé–‰çœ¼ï¼‰",
        overlayDone: "å®Œæˆï¼ˆå·²å®šå¦ï¼‰",
        shakeNotEnabled: "æœªå•Ÿç”¨",
        shakeCollecting: "æ”¶é›†ä¸­â€¦ï¼ˆæ–æ™ƒä¸€æ¬¡ = æŠ•å¹£ä¸€æ¬¡ï¼‰",
        shakeDone: "å·²å®šå¦",
        shakeStopped: "å·²åœæ­¢",
        shakeDenied: "ç„¡æ³•å•Ÿç”¨ï¼ˆæœªæˆæ¬Š/ä¸æ”¯æ´ï¼‰",
        slideLocked: "é–å®š",
        slideWaiting: "å¾…æ“ä½œ",
        slideCollecting: "æ”¶é›†ä¸­â€¦",
        slideDone: "å·²å®šå¦",
        POF: "ç¦é»"
      },
      "en": {
        langLabel: "Language",
        title: "ğŸ“œ Geomancy Ritual",
        btnManual: "Calculate (Manual Figures)",
        btnRandom: "Pure Random (Math.random)",
        tapTitle: "Eyes-closed Tap Casting (16 taps: Fireâ†’Airâ†’Waterâ†’Earth Ã—4 Mothers)",
        tapDesc: "Tap order is fixed: Mother 1 Fire/Air/Water/Earth â†’ Mother 2 â†’ Mother 3 â†’ Mother 4. Total 16 taps.<br>Each tap uses (time delta + tap position) parity to decide 1 (single) / 2 (double).",
        btnTapStart: "Start Eyes-closed Tapping",
        btnTapCancel: "Cancel / Close",
        shakeTitle: "Shake Coin Casting (16 flips: Fireâ†’Airâ†’Waterâ†’Earth Ã—4)",
        shakeDesc: "Press â€œEnable Shakeâ€, then each shake counts as 1 coin flip until 16 flips complete. iOS may ask for permission.<br>Rule: HEADS â†’ 1 (single), TAILS â†’ 2 (double)",
        shakeStatusLabel: "Status",
        shakeProgLabel: "Progress",
        shakeLastLabel: "Last",
        btnShakeEnable: "Enable Shake",
        btnShakeStop: "Stop",
        slideTitle: "Slide Casting (must enable first)",
        slideDesc: "Press â€œEnable Slide Castingâ€, then press-and-slide in the pad below. On release, the path is split into 16 segments; each segment parity decides 1/2.",
        btnSlideEnable: "Enable Slide Casting",
        btnSlideDisable: "Stop / Lock Slide",
        slidePadLocked: "(Locked) Press â€œEnable Slide Castingâ€ first",
        slidePadEnabled: "(Enabled) Press and slide here â†’ release to cast",
        gStatus: "Status: ",
        gDist: "Distance: ",
        gSeg: "Segments: ",
        qLabel: "Question (optional)",
        qPlaceholder: "e.g. Where is this relationship heading in 3 months? / Is this collaboration worth it?",
        qCountLabel: "Chars",
        qHint: "Tip: shown above results after casting",
        qPreviewTitle: "Question",
        houseTitle: "ğŸ›ï¸ House Chart",
        footer: 'For feedback, contact me<br><b>instagram: grove_and_roots</b>',
        overlayTitle: "Eyes-closed Tap Casting",
        overlayCancel: "Cancel",
        overlayReset: "Reset",
        overlayPad: "Tap Here (eyes closed)",
        overlayDone: "Done (cast completed)",
        shakeNotEnabled: "Not enabled",
        shakeCollecting: "Collectingâ€¦ (1 shake = 1 flip)",
        shakeDone: "Cast completed",
        shakeStopped: "Stopped",
        shakeDenied: "Cannot enable (permission/unsupported)",
        slideLocked: "Locked",
        slideWaiting: "Ready",
        slideCollecting: "Collectingâ€¦",
        slideDone: "Cast completed",
        POF: "Part of Fortune"
      }
    };

    /* ä½ çš„ä¸­æ–‡å¦åå°ç…§ï¼ˆç¹é«”ä¸­æ–‡ç”¨ï¼‰ */
    const FIG_ZH = {
      "Via": "é“è·¯",
      "Populus": "ç¾¤çœ¾",
      "Fortuna Major": "å¤§å¹¸é‹",
      "Fortuna Minor": "å°å¹¸é‹",
      "Conjunctio": "çµåˆ",
      "Albus": "ç™½è‰²",
      "Carcer": "é™åˆ¶",
      "Caput Draconis": "é¾é ­",
      "Rubeus": "ç´…è‰²",
      "Acquisitio": "ç²å¾—",
      "Cauda": "é¾å°¾",          // ä½ çš„ç¨‹å¼è£¡åç¨±æ˜¯ "Cauda"
      "Cauda Draconis": "é¾å°¾", // è‹¥æœªä¾†ä½ æ”¹æˆå…¨åä¹Ÿèƒ½ç”¨
      "Amissio": "å¤±å»",
      "Puella": "å¥³å­",
      "Tristitia": "æ‚²å‚·",
      "Puer": "ç”·å­",
      "Laetitia": "å¤§å¿«æ¨‚"
    };

    function setText(id, html){ const el=document.getElementById(id); if(el) el.innerHTML = html; }
    function setPlaceholder(id, v){ const el=document.getElementById(id); if(el) el.placeholder = v; }

    let currentLang = "zh-Hant";

    function displayFigureName(enName){
      if (currentLang === "zh-Hant") return (FIG_ZH[enName] || enName);
      return enName;
    }

    function applyLang(lang){
      currentLang = lang;
      const t = I18N[lang] || I18N["zh-Hant"];

      setText("ui_langLabel", t.langLabel);
      setText("ui_title", t.title);
      setText("ui_btnManual", t.btnManual);
      setText("ui_btnRandom", t.btnRandom);

      setText("ui_tapTitle", t.tapTitle);
      setText("ui_tapDesc", t.tapDesc);
      setText("ui_btnTapStart", t.btnTapStart);
      setText("ui_btnTapCancel", t.btnTapCancel);

      setText("ui_shakeTitle", t.shakeTitle);
      setText("ui_shakeDesc", t.shakeDesc);
      setText("ui_shakeStatusLabel", t.shakeStatusLabel);
      setText("ui_shakeProgLabel", t.shakeProgLabel);
      setText("ui_shakeLastLabel", t.shakeLastLabel);
      setText("ui_btnShakeEnable", t.btnShakeEnable);
      setText("ui_btnShakeStop", t.btnShakeStop);

      setText("ui_slideTitle", t.slideTitle);
      setText("ui_slideDesc", t.slideDesc);
      setText("ui_btnSlideEnable", t.btnSlideEnable);
      setText("ui_btnSlideDisable", t.btnSlideDisable);

      setText("ui_qLabel", t.qLabel);
      setPlaceholder("questionInput", t.qPlaceholder);
      setText("ui_qCountLabel", t.qCountLabel);
      setText("ui_qHint", t.qHint);
      setText("ui_qPreviewTitle", t.qPreviewTitle);

      setText("ui_houseTitle", t.houseTitle);
      setText("ui_footer", t.footer);

      setText("ui_overlayTitle", t.overlayTitle);
      setText("ui_overlayCancel", t.overlayCancel);
      setText("ui_overlayReset", t.overlayReset);
      document.getElementById("tapPad").textContent = t.overlayPad;

      // slide pad text sync
      const pad = document.getElementById("gesturePad");
      if (pad.classList.contains("disabled")) pad.textContent = t.slidePadLocked;
      else pad.textContent = t.slidePadEnabled;

      localStorage.setItem("geomancy_lang", lang);
      document.documentElement.lang = (lang === "en") ? "en" : "zh-Hant";

      // é‡æ–°æ¸²æŸ“ä¸‹æ‹‰é¸å–®é¡¯ç¤ºæ–‡å­—ï¼ˆä¸æ”¹ valueï¼‰
      populateSelects(true);
    }

    /* å¦è±¡å®šç¾©ï¼ˆç¶­æŒè‹±æ–‡è­˜åˆ¥ + codeï¼‰ */
    const figureList = [
      {name:"Via",code:"1111"}, {name:"Populus",code:"2222"},
      {name:"Conjunctio",code:"2112"}, {name:"Carcer",code:"1221"},
      {name:"Caput Draconis",code:"2111"}, {name:"Cauda",code:"1112"},
      {name:"Puella",code:"1211"},
      {name:"Puer",code:"1121"},
      {name:"Fortuna Major",code:"2211"}, {name:"Fortuna Minor",code:"1122"},
      {name:"Rubeus",code:"2122"}, {name:"Albus",code:"2212"},
      {name:"Acquisitio",code:"2121"}, {name:"Amissio",code:"1212"},
      {name:"Tristitia",code:"2221"}, {name:"Laetitia",code:"1222"}
    ];

    function add(f1,f2){ return f1.map((v,i)=>v===f2[i]?2:1); }
    function renderDotsStr(fig){ return fig.map(v=>v===1?"â—":"â— â—"); }

    /* ç›¾ç›¤ cellï¼šå–æ¶ˆå¦åé¡¯ç¤ºï¼ˆä½ è¦æ±‚çš„ï¼‰ */
    function createCell(fig, idx, className=""){
      const dots = renderDotsStr(fig).join("<br>");
      return `<div class="cell ${className}">
        <div class="idx">${idx}</div>
        <div class="dots">${dots}</div>
      </div>`;
    }

    /* å•é¡Œè¼¸å…¥ */
    const qInput = document.getElementById("questionInput");
    const qCount = document.getElementById("qCount");
    const qPreview = document.getElementById("questionPreview");
    const qPreviewText = document.getElementById("questionPreviewText");

    function getQuestionText(){ return (qInput.value || "").trim(); }
    function updateQuestionCount(){ qCount.textContent = String((qInput.value || "").length); }
    function renderQuestionPreview(){
      const q = getQuestionText();
      if (!q){
        qPreview.style.display = "none";
        qPreviewText.textContent = "";
        return;
      }
      qPreview.style.display = "block";
      qPreviewText.textContent = q;
    }
    qInput.addEventListener("input", ()=>{ updateQuestionCount(); });
    updateQuestionCount();

    /* é›™ç›¤è¨ˆç®— */
    function runShield(m1,m2,m3,m4){
      let d5=[m1[0],m2[0],m3[0],m4[0]],
          d6=[m1[1],m2[1],m3[1],m4[1]],
          d7=[m1[2],m2[2],m3[2],m4[2]],
          d8=[m1[3],m2[3],m3[3],m4[3]],
          n9=add(m1,m2), n10=add(m3,m4),
          n11=add(d5,d6), n12=add(d7,d8),
          w13=add(n9,n10), w14=add(n11,n12),
          j15=add(w13,w14), r16=add(m1,j15);

      const all=[null,m1,m2,m3,m4,d5,d6,d7,d8,n9,n10,n11,n12,w13,w14,j15,r16];

      document.getElementById("s_row1").innerHTML = [8,7,6,5,4,3,2,1].map(i=>createCell(all[i],i)).join("");
      document.getElementById("s_row2").innerHTML = [12,11,10,9].map(i=>createCell(all[i],i)).join("");
      document.getElementById("s_row3").innerHTML = [14,13].map(i=>createCell(all[i],i)).join("");
      document.getElementById("s_row4").innerHTML = createCell(all[15],15,"f15");
      document.getElementById("s_row5").innerHTML = createCell(all[16],16,"f16");

      renderHouseSVG(all);
      renderQuestionPreview();
    }

    /* 12 å®®ä½ï¼šåªé¡¯ç¤ºé»å‹ï¼ˆä¸é¡¯ç¤ºå¦åã€ä¸é¡¯ç¤ºå®®ä½æ•¸å­—ï¼‰ */
    function renderHouseSVG(all){
      const size=320, mid=160, iStart=82, iEnd=238;

      let tp=0, sp=0;
      for(let i=1;i<=12;i++){ all[i].forEach(p=>{ tp+=p; if(p===1) sp++; }); }
      const pars=(tp%12)||12, idxP=(sp%12)||12;

      const baseCenters={
        1:[52,160],  2:[42,242],  3:[78,281],  4:[160,275],
        5:[242,281], 6:[272,242], 7:[268,160], 8:[272,72],
        9:[242,39], 10:[160,45], 11:[78,39],  12:[48,72]
      };

      const OUT = 1.03;
      const centers = {};
      for (let i=1;i<=12;i++){
        const [x,y]=baseCenters[i];
        centers[i]=[ mid + (x-mid)*OUT, mid + (y-mid)*OUT ];
      }

      const t = I18N[currentLang] || I18N["zh-Hant"];

      let svg=`<svg viewBox="0 0 ${size} ${size}">
        <rect x="5" y="5" width="310" height="310" class="line"/>
        <polygon points="${mid},5 315,${mid} ${mid},315 5,${mid}" class="line"/>
        <rect x="${iStart}" y="${iStart}" width="156" height="156" class="line"/>
        <line x1="5" y1="5" x2="${iStart}" y2="${iStart}" class="line"/>
        <line x1="315" y1="5" x2="${iEnd}" y2="${iStart}" class="line"/>
        <line x1="5" y1="315" x2="${iStart}" y2="${iEnd}" class="line"/>
        <line x1="315" y1="315" x2="${iEnd}" y2="${iEnd}" class="line"/>
        <text x="${mid}" y="${mid-15}" class="h-meta" text-anchor="middle">SOUL</text>
        <text x="${mid}" y="${mid+8}" class="h-meta" text-anchor="middle">${t.POF}ï¼š${pars}</text>
        <text x="${mid}" y="${mid+25}" class="h-meta" text-anchor="middle">indexï¼š${idxP}</text>`;

      for(let i=1;i<=12;i++){
        const [cx,cy]=centers[i];
        const dots=renderDotsStr(all[i]);
        svg+=`<g transform="translate(${cx},${cy})">
          <g transform="translate(0,-4)">
            <text y="-10" class="h-dots">${dots[0]}</text>
            <text y="0" class="h-dots">${dots[1]}</text>
            <text y="10" class="h-dots">${dots[2]}</text>
            <text y="20" class="h-dots">${dots[3]}</text>
          </g>
        </g>`;
      }

      svg+=`</svg>`;
      document.getElementById("h_container").innerHTML = svg;
    }

    /* ä¸‹æ‹‰é¸å–®ï¼šç¹ä¸­é¡¯ç¤ºä¸­æ–‡å¦åï¼Œè‹±æ–‡é¡¯ç¤ºè‹±æ–‡å¦å */
    function populateSelects(keepSelected){
      const ids = ['m1_s','m2_s','m3_s','m4_s'];
      const prev = {};
      if (keepSelected){
        ids.forEach(id => prev[id] = document.getElementById(id).value);
      }

      const sorted = figureList.slice().sort((a,b)=>{
        const an = displayFigureName(a.name);
        const bn = displayFigureName(b.name);
        return an.localeCompare(bn, currentLang === "en" ? "en" : "zh-Hant");
      });

      ids.forEach(id=>{
        const s=document.getElementById(id);
        s.innerHTML="";
        sorted.forEach(f=>{
          const o=document.createElement("option");
          o.value=f.code;
          o.text = displayFigureName(f.name);
          s.appendChild(o);
        });
        if (keepSelected && prev[id]) s.value = prev[id];
      });
    }

    window.manualCast = function(){
      const getV = (id) => document.getElementById(id).value.split("").map(Number);
      runShield(getV('m1_s'), getV('m2_s'), getV('m3_s'), getV('m4_s'));
    };

    window.randomCast = function(){
      const r = () => [1,1,1,1].map(() => Math.floor(Math.random()*2)+1);
      const m1=r(), m2=r(), m3=r(), m4=r();
      m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
      runShield(m1,m2,m3,m4);
    };

    /* é–‰çœ¼é»æ“Šèµ·å¦ */
    const overlay = document.getElementById("tapOverlay");
    const tapPad = document.getElementById("tapPad");
    const tapProg = document.getElementById("tapProg");
    const tapStage = document.getElementById("tapStage");

    let tapCount = 0;
    let tapPoints = [];
    let lastTapT = 0;
    const elemNames = ["ç«","é¢¨","æ°´","åœŸ"];
    const elemNamesEN = ["Fire","Air","Water","Earth"];

    function stageLabel(n){
      const mother = Math.floor(n/4)+1;
      const idx = n%4;
      if (currentLang === "en") return `Mother ${mother} / ${elemNamesEN[idx]}`;
      return `ç¬¬ ${mother} æ¯å¦ï¼${elemNames[idx]}`;
    }
    function pointFromTap(ts, x, y){
      const dt = ts - (lastTapT || ts);
      const mix = (dt * 7) + (x * 3) + (y * 5) + (ts % 997);
      return (Math.abs(Math.floor(mix)) % 2 === 0) ? 2 : 1;
    }

    window.startTapCast = function(){
      overlay.style.display = "flex";
      resetTapCast();
    };
    window.cancelTapCast = function(){ overlay.style.display = "none"; };
    window.resetTapCast = function(){
      tapCount = 0; tapPoints = []; lastTapT = 0;
      tapProg.textContent = "0";
      tapStage.textContent = stageLabel(0);
      tapPad.textContent = (I18N[currentLang]||I18N["zh-Hant"]).overlayPad;
    };

    function finalizeTapCast(){
      const m1 = tapPoints.slice(0,4);
      const m2 = tapPoints.slice(4,8);
      const m3 = tapPoints.slice(8,12);
      const m4 = tapPoints.slice(12,16);

      m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
      runShield(m1,m2,m3,m4);

      tapPad.textContent = (I18N[currentLang]||I18N["zh-Hant"]).overlayDone;
      overlay.style.display = "none";
    }

    tapPad.addEventListener("click", (e)=>{
      if (tapCount >= 16) return;

      const rect = tapPad.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const ts = (typeof performance !== "undefined" ? performance.now() : Date.now());

      const p = pointFromTap(ts, x, y);
      tapPoints.push(p);
      lastTapT = ts;

      tapCount++;
      tapProg.textContent = String(tapCount);
      if (tapCount < 16) tapStage.textContent = stageLabel(tapCount);
      tapPad.textContent = (currentLang==="en") ? `Tapped ${tapCount}/16` : `å·²é»æ“Š ${tapCount}/16`;

      if (tapCount === 16) finalizeTapCast();
    });

    /* æ»‘å‹•èµ·å¦ï¼ˆéœ€å…ˆå•Ÿå‹•ï¼‰ */
    (function setupSlideCast(){
      const pad = document.getElementById("gesturePad");
      const gStatus = document.getElementById("gStatus");
      const gDist = document.getElementById("gDist");
      const gSeg = document.getElementById("gSeg");

      let slideEnabled = false;

      let down = false;
      let lastX = 0, lastY = 0;
      let totalTravel = 0;
      let increments = [];

      function setGStatus(t){ gStatus.textContent = t; }
      function setGDist(v){ gDist.textContent = String(Math.round(v)); }
      function setGSeg(v){ gSeg.textContent = String(v); }

      function hypot(dx,dy){ return Math.hypot(dx,dy); }
      function pointFromDistance(d){ return (Math.floor(d) % 2 === 0) ? 2 : 1; }

      function resetSlideUI(){
        down = false;
        totalTravel = 0;
        increments = [];
        setGDist(0);
        setGSeg(0);
      }

      function finalizeSlideCast(){
        const total = Math.max(totalTravel, 80);
        const target = total / 16;

        let segVals = [];
        let acc = 0;
        let made = 0;

        for (let i=0; i<increments.length && made<16; i++){
          acc += increments[i];
          if (acc >= target){
            segVals.push(pointFromDistance(acc * 13 + (i*17)));
            made++;
            acc = 0;
          }
        }
        while (segVals.length < 16){
          const t = (typeof performance !== "undefined" ? performance.now() : Date.now());
          segVals.push(pointFromDistance((total + segVals.length*31 + t)));
        }

        const m1 = segVals.slice(0,4);
        const m2 = segVals.slice(4,8);
        const m3 = segVals.slice(8,12);
        const m4 = segVals.slice(12,16);

        m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
        runShield(m1,m2,m3,m4);

        setGStatus((I18N[currentLang]||I18N["zh-Hant"]).slideDone);
        setGSeg(16);
      }

      function startSlide(x,y){
        if (!slideEnabled) return;
        down = true;
        totalTravel = 0;
        increments = [];
        lastX = x; lastY = y;
        setGStatus((I18N[currentLang]||I18N["zh-Hant"]).slideCollecting);
        setGDist(0);
        setGSeg(0);
      }
      function moveSlide(x,y){
        if(!slideEnabled || !down) return;
        const d = hypot(x-lastX, y-lastY);
        if (d > 0){
          increments.push(d);
          totalTravel += d;
        }
        lastX = x; lastY = y;
        setGDist(totalTravel);

        const est = Math.min(16, Math.floor((totalTravel / Math.max(totalTravel,80)) * 16));
        setGSeg(est);
      }
      function endSlide(){
        if(!slideEnabled || !down) return;
        down = false;
        finalizeSlideCast();
      }

      window.enableSlideCast = function(){
        slideEnabled = true;
        pad.classList.remove("disabled");
        pad.textContent = (I18N[currentLang]||I18N["zh-Hant"]).slidePadEnabled;
        setGStatus((I18N[currentLang]||I18N["zh-Hant"]).slideWaiting);
        resetSlideUI();
      };

      window.disableSlideCast = function(){
        slideEnabled = false;
        pad.classList.add("disabled");
        pad.textContent = (I18N[currentLang]||I18N["zh-Hant"]).slidePadLocked;
        setGStatus((I18N[currentLang]||I18N["zh-Hant"]).slideLocked);
        resetSlideUI();
      };

      pad.addEventListener("touchstart", (e)=>{
        if (!slideEnabled) return;
        e.preventDefault();
        const t = e.touches[0];
        startSlide(t.clientX, t.clientY);
      }, {passive:false});

      pad.addEventListener("touchmove", (e)=>{
        if (!slideEnabled) return;
        e.preventDefault();
        const t = e.touches[0];
        moveSlide(t.clientX, t.clientY);
      }, {passive:false});

      pad.addEventListener("touchend", (e)=>{
        if (!slideEnabled) return;
        e.preventDefault();
        endSlide();
      }, {passive:false});

      pad.addEventListener("mousedown", (e)=>{ if(!slideEnabled) return; e.preventDefault(); startSlide(e.clientX, e.clientY); });
      window.addEventListener("mousemove", (e)=>{ moveSlide(e.clientX, e.clientY); });
      window.addEventListener("mouseup", ()=>{ endSlide(); });

      window.disableSlideCast();
    })();

    /* æ–æ™ƒæŠ•å¹£ï¼ˆå«å‹•ç•«ï¼‰ */
    const coinEl = document.getElementById("coin");
    const shakeStatusEl = document.getElementById("shakeStatus");
    const shakeProgEl = document.getElementById("shakeProg");
    const shakeLastEl = document.getElementById("shakeLast");

    let shakeEnabled = false;
    let shakePoints = [];
    let lastShakeTime = 0;

    const SHAKE_THRESHOLD = 15;
    const SHAKE_COOLDOWN_MS = 550;

    function setShakeStatus(t){ shakeStatusEl.textContent = t; }
    function setShakeProg(n){ shakeProgEl.textContent = String(n); }
    function setShakeLast(t){ shakeLastEl.textContent = t; }

    function resetShakeCoin(){
      shakePoints = [];
      lastShakeTime = 0;
      setShakeProg(0);
      setShakeLast("â€”");
    }

    function coinFlipAnimation(isHeads){
      coinEl.classList.remove("flip-heads","flip-tails");
      void coinEl.offsetWidth;
      coinEl.classList.add(isHeads ? "flip-heads" : "flip-tails");
    }

    function pointFromCoin(isHeads){
      return isHeads ? 1 : 2;
    }

    function finalizeShakeCoin(){
      const m1 = shakePoints.slice(0,4);
      const m2 = shakePoints.slice(4,8);
      const m3 = shakePoints.slice(8,12);
      const m4 = shakePoints.slice(12,16);

      m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
      runShield(m1,m2,m3,m4);

      setShakeStatus((I18N[currentLang]||I18N["zh-Hant"]).shakeDone);
      shakeEnabled = false;
      window.removeEventListener("devicemotion", onDeviceMotion, {passive:true});
    }

    function decideHeadsFromMotion(mag){
      const t = (typeof performance !== "undefined" ? performance.now() : Date.now());
      const mix = Math.floor(mag * 1000 + t * 17);
      return (mix % 2) === 0;
    }

    function onDeviceMotion(e){
      if (!shakeEnabled) return;

      const now = Date.now();
      if (now - lastShakeTime < SHAKE_COOLDOWN_MS) return;

      const acc = e.accelerationIncludingGravity || e.acceleration;
      if (!acc) return;

      const ax = acc.x || 0, ay = acc.y || 0, az = acc.z || 0;
      const mag = Math.sqrt(ax*ax + ay*ay + az*az);

      if (mag < SHAKE_THRESHOLD) return;

      lastShakeTime = now;

      const isHeads = decideHeadsFromMotion(mag);
      coinFlipAnimation(isHeads);

      const p = pointFromCoin(isHeads);
      shakePoints.push(p);

      setShakeProg(shakePoints.length);
      setShakeLast(isHeads ? "HEADS â†’ 1" : "TAILS â†’ 2");

      if (shakePoints.length >= 16) finalizeShakeCoin();
    }

    async function requestMotionPermissionIfNeeded(){
      if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
        const res = await DeviceMotionEvent.requestPermission();
        if (res !== "granted") throw new Error("motion permission denied");
      }
    }

    window.enableShakeCoin = async function(){
      try{
        await requestMotionPermissionIfNeeded();
        resetShakeCoin();
        shakeEnabled = true;
        setShakeStatus((I18N[currentLang]||I18N["zh-Hant"]).shakeCollecting);
        window.addEventListener("devicemotion", onDeviceMotion, {passive:true});
      }catch(err){
        setShakeStatus((I18N[currentLang]||I18N["zh-Hant"]).shakeDenied);
      }
    };

    window.disableShakeCoin = function(){
      shakeEnabled = false;
      window.removeEventListener("devicemotion", onDeviceMotion, {passive:true});
      setShakeStatus((I18N[currentLang]||I18N["zh-Hant"]).shakeStopped);
    };

    /* init */
    function init(){
      // populate selects first
      populateSelects(false);

      const langSelect = document.getElementById("langSelect");
      const saved = localStorage.getItem("geomancy_lang");
      if (saved && (saved==="en" || saved==="zh-Hant")) langSelect.value = saved;

      applyLang(langSelect.value);

      langSelect.addEventListener("change", ()=>{
        applyLang(langSelect.value);
        // ä¿æŒç›®å‰é¸å–çš„å››æ¯å¦ï¼Œç›´æ¥é‡ç®—ï¼ˆä¸æ”¹å¦ï¼‰
        const getV = (id) => document.getElementById(id).value.split("").map(Number);
        runShield(getV('m1_s'), getV('m2_s'), getV('m3_s'), getV('m4_s'));
        tapStage.textContent = stageLabel(tapCount);
      });

      // åˆå§‹éš¨æ©Ÿ
      randomCast();
    }
    init();
  </script>
</body>
</html>
