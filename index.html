<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>åœ°å é›™ç›¤ç³»çµ± - å¦è±¡ä¿®æ­£ç‰ˆï¼ˆå¤šæ¨¡å¼ï¼‰</title>
  <style>
    :root { --gold: #d4af37; --bg: #1a1a1a; --card: #262626; --text: #eee; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--gold); font-family: "Times New Roman", serif; margin: 0; padding: 10px; text-align: center; }

    .controls { background: var(--card); border: 1px solid #444; padding: 12px; border-radius: 8px; margin-bottom: 14px; max-width: 520px; margin: 0 auto; }
    .select-row { display: flex; justify-content: space-between; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
    select { background: #333; color: var(--gold); border: 1px solid var(--gold); border-radius: 4px; font-size: 11px; flex: 1 1 calc(25% - 6px); height: 32px; text-align: center; min-width: 120px; }

    .btn-row { display: flex; gap: 8px; justify-content: space-between; flex-wrap: wrap; }
    button { background: var(--gold); color: #000; border: none; padding: 10px 12px; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer; flex: 1 1 160px; }
    button.alt { background:#444; color:#fff; }
    button.soft { background: rgba(212,175,55,0.18); color: var(--gold); border: 1px solid rgba(212,175,55,0.45); }

    .mode-box {
      max-width: 520px;
      margin: 0 auto 14px;
      border: 1px solid rgba(212,175,55,0.45);
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
      padding: 12px;
      text-align: left;
    }
    .mode-title { color: var(--gold); font-weight: bold; font-size: 13px; margin-bottom: 6px; }
    .mode-sub { color: #bdbdbd; font-size: 12px; line-height: 1.45; margin-bottom: 10px; }

    .pad {
      height: 110px;
      border-radius: 10px;
      border: 1px solid rgba(212,175,55,0.35);
      background: linear-gradient(180deg, rgba(212,175,55,0.06), rgba(0,0,0,0.0));
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.75);
      font-size: 12px;
      user-select: none;
      -webkit-user-select: none;
    }
    .pad.slide { touch-action: none; } /* é¿å…æ»‘å‹•è¢«é é¢æ²å‹•åƒæ‰ */

    .status-row { margin-top: 10px; color:#bdbdbd; font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .status-row b { color: var(--gold); }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,0.35);
      background: rgba(212,175,55,0.06);
      color: #cfcfcf;
      font-size: 12px;
    }
    .pill b{ color: var(--gold); }

    /* --- Shake Coin UI --- */
    .coin-wrap{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .coin{
      width:76px; height:76px; border-radius:50%;
      border: 2px solid rgba(212,175,55,0.75);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.28), rgba(212,175,55,0.16), rgba(0,0,0,0.06));
      position: relative;
      display:flex; align-items:center; justify-content:center;
      transform-style: preserve-3d;
      perspective: 800px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      user-select:none; -webkit-user-select:none;
    }
    .coin::before, .coin::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:50%;
      border: 1px dashed rgba(212,175,55,0.45);
    }
    .coin-face{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      color: var(--gold);
      backface-visibility: hidden;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    .coin-front{ transform: rotateY(0deg); }
    .coin-back{ transform: rotateY(180deg); color: rgba(255,255,255,0.85); }

    .coin.flip-heads{ animation: coinFlipHeads 520ms ease-out; }
    .coin.flip-tails{ animation: coinFlipTails 520ms ease-out; }

    @keyframes coinFlipHeads{
      0%{ transform: rotateY(0) rotateZ(0) scale(1); }
      35%{ transform: rotateY(270deg) rotateZ(8deg) scale(1.05); }
      100%{ transform: rotateY(360deg) rotateZ(0) scale(1); }
    }
    @keyframes coinFlipTails{
      0%{ transform: rotateY(0) rotateZ(0) scale(1); }
      35%{ transform: rotateY(450deg) rotateZ(-8deg) scale(1.05); }
      100%{ transform: rotateY(540deg) rotateZ(0) scale(1); }
    }

    .shield-box { border: 2px solid var(--gold); background: var(--card); padding: 5px; max-width: 500px; margin: 0 auto; }
    .row-8 { display: flex; width: 100%; border-bottom: 1px solid #444; }
    .row-4 { display: flex; width: 100%; justify-content: space-around; padding-top: 10px; }
    .row-2 { display: flex; width: 100%; justify-content: space-around; padding-top: 15px; }
    .row-1 { display: flex; width: 100%; justify-content: center; padding-top: 15px; }

    .cell { flex: 1 1 0; min-width: 0; border: 0.5px solid #333; padding: 4px 0; display: flex; flex-direction: column; align-items: center; background: #1f1f1f; }
    .idx { font-size: 9px; color: #888; font-weight: bold; }
    .dots { font-size: 10px; line-height: 1.1; color: #f9d342; font-family: monospace; padding: 3px 0; }
    .name { font-size: 7px; color: #ccc; transform: scale(0.85); white-space: nowrap; margin-top: 2px; font-weight: bold; }

    .f15 { width: 85px; background: #333; clip-path: polygon(0 0, 100% 0, 50% 100%); padding-bottom: 18px; border: 1px solid var(--gold); }
    .reconciler-wrap { display: flex; justify-content: center; margin-top: 10px; padding-bottom: 5px; }
    .f16 { width: 90px; border: 1px dashed var(--gold); background: rgba(212, 175, 55, 0.05); border-radius: 10px; padding: 5px 0; position: relative; }
    .f16::before { content: "RECONCILER"; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 0 5px; font-size: 8px; color: var(--gold); opacity: 0.7; }

    .house-svg-container { width: 340px; height: 340px; margin: 20px auto; position: relative; }
    svg { width: 100%; height: 100%; }
    .line { stroke: var(--gold); stroke-width: 1.5; fill: none; }
    .h-dots { fill: #f9d342; font-size: 10.5px; font-family: monospace; text-anchor: middle; }
    .h-meta { fill: var(--gold); font-size: 9px; font-weight: bold; }

    .footer { margin-top: 30px; padding: 20px 10px; border-top: 1px solid #333; font-size: 12px; color: #888; }
    .footer b { color: var(--gold); }

    /* Tap overlay */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.92);
      display: none;
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .overlay-card {
      width: min(520px, 94vw);
      border: 1px solid rgba(212,175,55,0.45);
      border-radius: 14px;
      padding: 16px;
      background: rgba(255,255,255,0.03);
      text-align: left;
    }
    .overlay-title { color: var(--gold); font-weight: bold; font-size: 14px; margin-bottom: 8px; }
    .overlay-sub { color:#cfcfcf; font-size: 12px; line-height: 1.5; margin-bottom: 12px; }
    .overlay-pad {
      height: 220px;
      border-radius: 12px;
      border: 1px solid rgba(212,175,55,0.35);
      background: radial-gradient(circle at 50% 40%, rgba(212,175,55,0.12), rgba(0,0,0,0.0));
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,0.75);
      font-size: 12px;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    .overlay-row { margin-top: 12px; display:flex; gap:8px; }
    .overlay-row button { flex: 1 1 auto; }

    @media (max-width: 420px) {
      .controls { padding: 10px; }
      select { flex: 1 1 calc(50% - 6px); min-width: 0; font-size: 12px; height: 34px; }
      button { font-size: 14px; }
    }
  </style>
</head>
<body>

  <h2>ğŸ“œ Geomancy Ritual</h2>

  <!-- æŒ‡å®šå¦è±¡ + Math.random -->
  <div class="controls">
    <div class="select-row">
      <select id="m1_s"></select>
      <select id="m2_s"></select>
      <select id="m3_s"></select>
      <select id="m4_s"></select>
    </div>
    <div class="btn-row">
      <button onclick="manualCast()">æŒ‡å®šå¦è±¡è¨ˆç®—</button>
      <button class="alt" onclick="randomCast()">ç´”éš¨æ©Ÿï¼ˆMath.randomï¼‰</button>
    </div>
  </div>

  <!-- é–‰çœ¼é»æ“Šèµ·å¦ï¼ˆå»ºè­°ï¼‰ -->
  <div class="mode-box">
    <div class="mode-title">é–‰çœ¼é»æ“Šèµ·å¦ï¼ˆ16 æ¬¡ï¼šç«â†’é¢¨â†’æ°´â†’åœŸï¼Œå››æ¯å¦ä¾åºï¼‰</div>
    <div class="mode-sub">
      é»æ“Šé †åºå›ºå®šç‚ºï¼š<b>ç¬¬ 1 æ¯å¦ ç«/é¢¨/æ°´/åœŸ</b> â†’ <b>ç¬¬ 2</b> â†’ <b>ç¬¬ 3</b> â†’ <b>ç¬¬ 4</b>ã€‚å…± 16 æ¬¡ã€‚<br>
      æ¯æ¬¡é»æ“Šä»¥ã€Œæ™‚é–“å·® + é»æ“Šåº§æ¨™ã€å–å¥‡å¶ï¼Œæ±ºå®šå–®é»(1)/é›™é»(2)ã€‚
    </div>
    <div class="btn-row">
      <button class="soft" onclick="startTapCast()">é–‹å§‹é–‰çœ¼é»æ“Š</button>
      <button class="alt" onclick="cancelTapCast()">å–æ¶ˆ/é—œé–‰</button>
    </div>
  </div>

  <!-- æ–æ™ƒæŠ•å¹£ï¼ˆå«å‹•ç•«ï¼‰ -->
  <div class="mode-box">
    <div class="mode-title">æ–æ™ƒæŠ•å¹£èµ·å¦ï¼ˆ16 æ¬¡ï¼šç«â†’é¢¨â†’æ°´â†’åœŸ Ã—4ï¼‰</div>
    <div class="mode-sub">
      é»æ“Šã€Œå•Ÿç”¨æ–æ™ƒã€å¾Œï¼Œæ–æ™ƒæ‰‹æ©Ÿä¸€æ¬¡è¨˜ 1 æ¬¡æŠ•å¹£ï¼Œç›´åˆ° 16 æ¬¡è‡ªå‹•å®šå¦ã€‚iOS å¯èƒ½æœƒè·³å‡ºæ¬Šé™è¦–çª—ï¼Œè«‹å…è¨±ã€‚
      <br>è¦å‰‡ï¼š<b>HEADS â†’ 1ï¼ˆå–®ï¼‰</b>ã€<b>TAILS â†’ 2ï¼ˆé›™ï¼‰</b>
    </div>

    <div class="coin-wrap">
      <div class="coin" id="coin">
        <div class="coin-face coin-front">HEADS</div>
        <div class="coin-face coin-back">TAILS</div>
      </div>

      <div style="flex:1 1 220px; min-width: 220px;">
        <div class="status-row" style="margin-top:0;">
          <span class="pill">ç‹€æ…‹ï¼š<b id="shakeStatus">æœªå•Ÿç”¨</b></span>
          <span class="pill">é€²åº¦ï¼š<b id="shakeProg">0</b>/16</span>
          <span class="pill">ä¸Šæ¬¡ï¼š<b id="shakeLast">â€”</b></span>
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <button class="soft" onclick="enableShakeCoin()">å•Ÿç”¨æ–æ™ƒ</button>
          <button class="alt" onclick="disableShakeCoin()">åœæ­¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ»‘å‹•èµ·å¦ï¼ˆåˆ†æ®µè·é›¢å–æ¨£ï¼Œé¿å…æ•´ç›¤åŒå¦ï¼‰ -->
  <div class="mode-box">
    <div class="mode-title">æŒ‰ä½æ»‘å‹•èµ·å¦ï¼ˆåˆ†æ®µè·é›¢å–æ¨£ â†’ å–®/é›™ï¼‰</div>
    <div class="mode-sub">
      åœ¨ä¸‹æ–¹å€å¡ŠæŒ‰ä½ä¸¦æ»‘å‹•ï¼Œæ”¾é–‹å¾Œå°‡è·¯å¾‘åˆ‡æˆ 16 æ®µï¼Œå„æ®µè·é›¢çš„å¥‡å¶æ±ºå®šé»æ•¸ï¼ˆé¿å…ã€Œç¸½è·é›¢ã€å°è‡´æ•´ç›¤åŒå¦ï¼‰ã€‚
    </div>
    <div id="gesturePad" class="pad slide">æŒ‰ä½æ­¤è™•ä¸¦æ»‘å‹• â†’ æ”¾é–‹å³å®šå¦</div>
    <div class="status-row">
      <span>ç‹€æ…‹ï¼š<b id="gStatus">ç­‰å¾…</b></span>
      <span>è·é›¢ï¼š<b id="gDist">0</b></span>
      <span>æ®µæ•¸ï¼š<b id="gSeg">0</b>/16</span>
    </div>
  </div>

  <div class="shield-box">
    <div id="s_row1" class="row-8"></div>
    <div id="s_row2" class="row-4"></div>
    <div id="s_row3" class="row-2"></div>
    <div id="s_row4" class="row-1"></div>
    <div id="s_row5" class="reconciler-wrap"></div>
  </div>

  <h3>ğŸ›ï¸ House Chart</h3>
  <div id="h_container" class="house-svg-container"></div>

  <div class="footer">
    å¦‚æœ‰ä»»ä½•å•é¡Œèˆ‡æ„è¦‹å›é¥‹ï¼Œè«‹èˆ‡æˆ‘è¯ç¹«<br>
    <b>instagram: grove_and_roots</b>
  </div>

  <!-- Tap overlay -->
  <div id="tapOverlay" class="overlay">
    <div class="overlay-card">
      <div class="overlay-title">é–‰çœ¼é»æ“Šèµ·å¦</div>
      <div class="overlay-sub">
        è«‹é–‰çœ¼ï¼Œéš¨æ„é»æ“Šä¸‹æ–¹å€å¡Š <b>16 æ¬¡</b>ã€‚<br>
        é€²åº¦ï¼š<b id="tapProg">0</b>/16ã€€ç›®å‰ï¼š<b id="tapStage">ç¬¬ 1 æ¯å¦ï¼ç«</b>
      </div>
      <div id="tapPad" class="overlay-pad">é»æˆ‘ï¼ˆé–‰çœ¼ï¼‰</div>
      <div class="overlay-row">
        <button class="alt" onclick="cancelTapCast()">å–æ¶ˆ</button>
        <button class="soft" onclick="resetTapCast()">é‡ç½®é€²åº¦</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- å¦è±¡å®šç¾© ---------------- */
    const figureList = [
      {name:"Via",code:"1111"}, {name:"Populus",code:"2222"},
      {name:"Conjunctio",code:"2112"}, {name:"Carcer",code:"1221"},
      {name:"Caput Draconis",code:"2111"}, {name:"Cauda",code:"1112"},
      {name:"Puella",code:"1211"},
      {name:"Puer",code:"1121"},
      {name:"Fortuna Major",code:"2211"}, {name:"Fortuna Minor",code:"1122"},
      {name:"Rubeus",code:"2122"}, {name:"Albus",code:"2212"},
      {name:"Acquisitio",code:"2121"}, {name:"Amissio",code:"1212"},
      {name:"Tristitia",code:"2221"}, {name:"Laetitia",code:"1222"}
    ];
    const figureNames = {};
    figureList.forEach(f => figureNames[f.code] = f.name);

    function add(f1,f2){ return f1.map((v,i)=>v===f2[i]?2:1); }
    function renderDotsStr(fig){ return fig.map(v=>v===1?"â—":"â— â—"); }

    function createCell(fig, idx, className=""){
      const code = fig.join("");
      const dots = renderDotsStr(fig).join("<br>");
      return `<div class="cell ${className}">
        <div class="idx">${idx}</div>
        <div class="dots">${dots}</div>
        <div class="name">${figureNames[code] || "Unknown"}</div>
      </div>`;
    }

    /* ---------------- ç›¾ç›¤/é›™ç›¤è¨ˆç®— ---------------- */
    function runShield(m1,m2,m3,m4){
      let d5=[m1[0],m2[0],m3[0],m4[0]],
          d6=[m1[1],m2[1],m3[1],m4[1]],
          d7=[m1[2],m2[2],m3[2],m4[2]],
          d8=[m1[3],m2[3],m3[3],m4[3]],
          n9=add(m1,m2), n10=add(m3,m4),
          n11=add(d5,d6), n12=add(d7,d8),
          w13=add(n9,n10), w14=add(n11,n12),
          j15=add(w13,w14), r16=add(m1,j15);

      const all=[null,m1,m2,m3,m4,d5,d6,d7,d8,n9,n10,n11,n12,w13,w14,j15,r16];

      document.getElementById("s_row1").innerHTML = [8,7,6,5,4,3,2,1].map(i=>createCell(all[i],i)).join("");
      document.getElementById("s_row2").innerHTML = [12,11,10,9].map(i=>createCell(all[i],i)).join("");
      document.getElementById("s_row3").innerHTML = [14,13].map(i=>createCell(all[i],i)).join("");
      document.getElementById("s_row4").innerHTML = createCell(all[15],15,"f15");
      document.getElementById("s_row5").innerHTML = createCell(all[16],16,"f16");

      renderHouseSVG(all);
    }

    /* ---------------- 12 å®®ä½ï¼šåªé¡¯ç¤ºå¦è±¡é»å‹ ---------------- */
    function renderHouseSVG(all){
      const size=320, mid=160, iStart=82, iEnd=238;

      let tp=0, sp=0;
      for(let i=1;i<=12;i++){ all[i].forEach(p=>{ tp+=p; if(p===1) sp++; }); }
      const pars=(tp%12)||12, idxP=(sp%12)||12;

      const baseCenters={
        1:[52,160],  2:[42,242],  3:[78,281],  4:[160,275],
        5:[242,281], 6:[272,242], 7:[268,160], 8:[272,72],
        9:[242,39], 10:[160,45], 11:[78,39],  12:[48,72]
      };

      const OUT = 1.03; // å¯è‡ªè¡Œæ”¹ 1.02~1.04
      const centers = {};
      for (let i=1;i<=12;i++){
        const [x,y]=baseCenters[i];
        centers[i]=[ mid + (x-mid)*OUT, mid + (y-mid)*OUT ];
      }

      let svg=`<svg viewBox="0 0 ${size} ${size}">
        <rect x="5" y="5" width="310" height="310" class="line"/>
        <polygon points="${mid},5 315,${mid} ${mid},315 5,${mid}" class="line"/>
        <rect x="${iStart}" y="${iStart}" width="156" height="156" class="line"/>
        <line x1="5" y1="5" x2="${iStart}" y2="${iStart}" class="line"/>
        <line x1="315" y1="5" x2="${iEnd}" y2="${iStart}" class="line"/>
        <line x1="5" y1="315" x2="${iStart}" y2="${iEnd}" class="line"/>
        <line x1="315" y1="315" x2="${iEnd}" y2="${iEnd}" class="line"/>
        <text x="${mid}" y="${mid-15}" class="h-meta" text-anchor="middle">SOUL</text>
        <text x="${mid}" y="${mid+8}" class="h-meta" text-anchor="middle">ç¦é»ï¼š${pars}</text>
        <text x="${mid}" y="${mid+25}" class="h-meta" text-anchor="middle">indexï¼š${idxP}</text>`;

      for(let i=1;i<=12;i++){
        const [cx,cy]=centers[i];
        const dots=renderDotsStr(all[i]);
        svg+=`<g transform="translate(${cx},${cy})">
          <g transform="translate(0,-4)">
            <text y="-10" class="h-dots">${dots[0]}</text>
            <text y="0" class="h-dots">${dots[1]}</text>
            <text y="10" class="h-dots">${dots[2]}</text>
            <text y="20" class="h-dots">${dots[3]}</text>
          </g>
        </g>`;
      }

      svg+=`</svg>`;
      document.getElementById("h_container").innerHTML = svg;
    }

    /* ---------------- æ–¹å¼ 1ï¼šæ‰‹å‹•æŒ‡å®šï¼ˆä¿ç•™ï¼‰ ---------------- */
    window.manualCast = function(){
      const getV = (id) => document.getElementById(id).value.split("").map(Number);
      runShield(getV('m1_s'), getV('m2_s'), getV('m3_s'), getV('m4_s'));
    };

    /* ---------------- æ–¹å¼ 2ï¼šç´”éš¨æ©Ÿï¼ˆä¿ç•™ï¼‰ ---------------- */
    window.randomCast = function(){
      const r = () => [1,1,1,1].map(() => Math.floor(Math.random()*2)+1);
      const m1=r(), m2=r(), m3=r(), m4=r();
      m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
      runShield(m1,m2,m3,m4);
    };

    /* ---------------- æ–¹å¼ 3ï¼šé–‰çœ¼é»æ“Šèµ·å¦ï¼ˆ16 tapsï¼‰ ---------------- */
    const overlay = document.getElementById("tapOverlay");
    const tapPad = document.getElementById("tapPad");
    const tapProg = document.getElementById("tapProg");
    const tapStage = document.getElementById("tapStage");

    let tapCount = 0;
    let tapPoints = [];
    let lastTapT = 0;
    const elemNames = ["ç«","é¢¨","æ°´","åœŸ"];

    function stageLabel(n){
      const mother = Math.floor(n/4)+1;
      const elem = elemNames[n%4];
      return `ç¬¬ ${mother} æ¯å¦ï¼${elem}`;
    }
    function pointFromTap(ts, x, y){
      const dt = ts - (lastTapT || ts);
      const mix = (dt * 7) + (x * 3) + (y * 5) + (ts % 997);
      return (Math.abs(Math.floor(mix)) % 2 === 0) ? 2 : 1;
    }

    window.startTapCast = function(){
      overlay.style.display = "flex";
      resetTapCast();
    };
    window.cancelTapCast = function(){ overlay.style.display = "none"; };
    window.resetTapCast = function(){
      tapCount = 0; tapPoints = []; lastTapT = 0;
      tapProg.textContent = "0";
      tapStage.textContent = stageLabel(0);
      tapPad.textContent = "é»æˆ‘ï¼ˆé–‰çœ¼ï¼‰";
    };

    function finalizeTapCast(){
      const m1 = tapPoints.slice(0,4);
      const m2 = tapPoints.slice(4,8);
      const m3 = tapPoints.slice(8,12);
      const m4 = tapPoints.slice(12,16);

      m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
      runShield(m1,m2,m3,m4);

      tapPad.textContent = "å®Œæˆï¼ˆå·²å®šå¦ï¼‰";
      overlay.style.display = "none";
    }

    tapPad.addEventListener("click", (e)=>{
      if (tapCount >= 16) return;

      const rect = tapPad.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const ts = (typeof performance !== "undefined" ? performance.now() : Date.now());

      const p = pointFromTap(ts, x, y);
      tapPoints.push(p);
      lastTapT = ts;

      tapCount++;
      tapProg.textContent = String(tapCount);
      if (tapCount < 16) tapStage.textContent = stageLabel(tapCount);
      tapPad.textContent = `å·²é»æ“Š ${tapCount}/16`;

      if (tapCount === 16) finalizeTapCast();
    });

    /* ---------------- æ–¹å¼ 4ï¼šæ»‘å‹•èµ·å¦ï¼ˆåˆ†æ®µè·é›¢å–æ¨£ï¼‰ ---------------- */
    (function setupSlideCast(){
      const pad = document.getElementById("gesturePad");
      const gStatus = document.getElementById("gStatus");
      const gDist = document.getElementById("gDist");
      const gSeg = document.getElementById("gSeg");

      let down = false;
      let lastX = 0, lastY = 0;
      let totalTravel = 0;
      let increments = [];

      function setGStatus(t){ gStatus.textContent = t; }
      function setGDist(v){ gDist.textContent = String(Math.round(v)); }
      function setGSeg(v){ gSeg.textContent = String(v); }

      function hypot(dx,dy){ return Math.hypot(dx,dy); }
      function pointFromDistance(d){ return (Math.floor(d) % 2 === 0) ? 2 : 1; }

      function finalizeSlideCast(){
        const total = Math.max(totalTravel, 80);
        const target = total / 16;

        let segVals = [];
        let acc = 0;
        let made = 0;

        for (let i=0; i<increments.length && made<16; i++){
          acc += increments[i];
          if (acc >= target){
            segVals.push(pointFromDistance(acc * 13 + (i*17)));
            made++;
            acc = 0;
          }
        }
        while (segVals.length < 16){
          const t = (typeof performance !== "undefined" ? performance.now() : Date.now());
          segVals.push(pointFromDistance((total + segVals.length*31 + t)));
        }

        const m1 = segVals.slice(0,4);
        const m2 = segVals.slice(4,8);
        const m3 = segVals.slice(8,12);
        const m4 = segVals.slice(12,16);

        m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
        runShield(m1,m2,m3,m4);

        setGStatus("å·²å®šå¦");
        setGSeg(16);
      }

      function startSlide(x,y){
        down = true;
        totalTravel = 0;
        increments = [];
        lastX = x; lastY = y;
        setGStatus("æ”¶é›†ä¸­â€¦");
        setGDist(0);
        setGSeg(0);
      }
      function moveSlide(x,y){
        if(!down) return;
        const d = hypot(x-lastX, y-lastY);
        if (d > 0){
          increments.push(d);
          totalTravel += d;
        }
        lastX = x; lastY = y;
        setGDist(totalTravel);

        const est = Math.min(16, Math.floor((totalTravel / Math.max(totalTravel,80)) * 16));
        setGSeg(est);
      }
      function endSlide(){
        if(!down) return;
        down = false;
        finalizeSlideCast();
      }

      pad.addEventListener("touchstart", (e)=>{
        e.preventDefault();
        const t = e.touches[0];
        startSlide(t.clientX, t.clientY);
      }, {passive:false});

      pad.addEventListener("touchmove", (e)=>{
        e.preventDefault();
        const t = e.touches[0];
        moveSlide(t.clientX, t.clientY);
      }, {passive:false});

      pad.addEventListener("touchend", (e)=>{
        e.preventDefault();
        endSlide();
      }, {passive:false});

      pad.addEventListener("mousedown", (e)=>{ e.preventDefault(); startSlide(e.clientX, e.clientY); });
      window.addEventListener("mousemove", (e)=>{ moveSlide(e.clientX, e.clientY); });
      window.addEventListener("mouseup", ()=>{ endSlide(); });
    })();

    /* ---------------- æ–¹å¼ 5ï¼šæ–æ™ƒæŠ•å¹£ï¼ˆå«å‹•ç•«ï¼‰ ---------------- */
    const coinEl = document.getElementById("coin");
    const shakeStatusEl = document.getElementById("shakeStatus");
    const shakeProgEl = document.getElementById("shakeProg");
    const shakeLastEl = document.getElementById("shakeLast");

    let shakeEnabled = false;
    let shakePoints = [];
    let lastShakeTime = 0;

    const SHAKE_THRESHOLD = 15;     // 12~18
    const SHAKE_COOLDOWN_MS = 550;  // 550~800

    function setShakeStatus(t){ shakeStatusEl.textContent = t; }
    function setShakeProg(n){ shakeProgEl.textContent = String(n); }
    function setShakeLast(t){ shakeLastEl.textContent = t; }

    function resetShakeCoin(){
      shakePoints = [];
      lastShakeTime = 0;
      setShakeProg(0);
      setShakeLast("â€”");
    }

    function coinFlipAnimation(isHeads){
      coinEl.classList.remove("flip-heads","flip-tails");
      void coinEl.offsetWidth;
      coinEl.classList.add(isHeads ? "flip-heads" : "flip-tails");
    }

    function pointFromCoin(isHeads){
      return isHeads ? 1 : 2; // HEADSâ†’1(å–®), TAILSâ†’2(é›™)
    }

    function finalizeShakeCoin(){
      const m1 = shakePoints.slice(0,4);
      const m2 = shakePoints.slice(4,8);
      const m3 = shakePoints.slice(8,12);
      const m4 = shakePoints.slice(12,16);

      m1_s.value=m1.join(""); m2_s.value=m2.join(""); m3_s.value=m3.join(""); m4_s.value=m4.join("");
      runShield(m1,m2,m3,m4);

      setShakeStatus("å·²å®šå¦");
      shakeEnabled = false;
      window.removeEventListener("devicemotion", onDeviceMotion, {passive:true});
    }

    function decideHeadsFromMotion(mag){
      const t = (typeof performance !== "undefined" ? performance.now() : Date.now());
      const mix = Math.floor(mag * 1000 + t * 17);
      return (mix % 2) === 0;
    }

    function onDeviceMotion(e){
      if (!shakeEnabled) return;

      const now = Date.now();
      if (now - lastShakeTime < SHAKE_COOLDOWN_MS) return;

      const acc = e.accelerationIncludingGravity || e.acceleration;
      if (!acc) return;

      const ax = acc.x || 0, ay = acc.y || 0, az = acc.z || 0;
      const mag = Math.sqrt(ax*ax + ay*ay + az*az);

      if (mag < SHAKE_THRESHOLD) return;

      lastShakeTime = now;

      const isHeads = decideHeadsFromMotion(mag);
      coinFlipAnimation(isHeads);

      const p = pointFromCoin(isHeads);
      shakePoints.push(p);

      setShakeProg(shakePoints.length);
      setShakeLast(isHeads ? "HEADS â†’ 1" : "TAILS â†’ 2");

      if (shakePoints.length >= 16){
        finalizeShakeCoin();
      }
    }

    async function requestMotionPermissionIfNeeded(){
      if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
        const res = await DeviceMotionEvent.requestPermission();
        if (res !== "granted") throw new Error("motion permission denied");
      }
    }

    window.enableShakeCoin = async function(){
      try{
        await requestMotionPermissionIfNeeded();
        resetShakeCoin();
        shakeEnabled = true;
        setShakeStatus("æ”¶é›†ä¸­â€¦ï¼ˆæ–æ™ƒä¸€æ¬¡ = æŠ•å¹£ä¸€æ¬¡ï¼‰");
        window.addEventListener("devicemotion", onDeviceMotion, {passive:true});
      }catch(err){
        setShakeStatus("ç„¡æ³•å•Ÿç”¨ï¼ˆæœªæˆæ¬Š/ä¸æ”¯æ´ï¼‰");
      }
    };

    window.disableShakeCoin = function(){
      shakeEnabled = false;
      window.removeEventListener("devicemotion", onDeviceMotion, {passive:true});
      setShakeStatus("å·²åœæ­¢");
    };

    /* ---------------- init ---------------- */
    function init(){
      ['m1_s','m2_s','m3_s','m4_s'].forEach(id=>{
        const s=document.getElementById(id);
        s.innerHTML="";
        figureList.slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(f=>{
          const o=document.createElement("option");
          o.value=f.code; o.text=f.name;
          s.appendChild(o);
        });
      });
      randomCast(); // é è¨­è·‘ä¸€æ¬¡ï¼ˆå¯æ”¹æˆä¸è‡ªå‹•èµ·å¦ï¼‰
    }
    init();
  </script>
</body>
</html>
